<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  /**
   * Run initializations on sidebar load.
   */
  $(function() {

    loadProviders();

    // Assign handler functions to elements
    $('#providers').change(onSelectProvider);
    $('#packages').change(onSelectPackage);
    $('#load-data-sets').click(onLoadDataSets);

  });

  function loadProviders() {

    google.script.run
      .withSuccessHandler(function(providers) {
        // First empty the description and packages selection as we are reloading a new list of packages
        $('#description').val('');
        $('#providers').empty();
        for (var provider of providers) {
          $('#providers').append($('<option>', {text:provider.title, value: provider.url}));
        }
        $('#providers').val(providers[0].url);
        onSelectProvider();
      })
      .getProviderList();
  }

  /**
   * Load the package list when the a provider is selected
   */
  function onSelectProvider() {

    const selectedProvider = $('#providers').val();
    $('#packages').empty();
    google.script.run
      .withSuccessHandler(function(packages) {
        console.log(packages);
        // First empty the description and packages selection as we are reloading a new list of packages
        $('#description').val('');
        for (const package of packages) {
          $('#packages').append($('<option>', {text:package.title, value: package.name}));
        }
      })
      .getPackageList(selectedProvider);
  }


  /**
   * Load the package description when a package is selected
   */
  function onSelectPackage() {

    const selectedProvider = $('#providers').val();
    const selectedPackageId = $('#packages').val();
    google.script.run
      .withSuccessHandler(
        function(packageInfo) {
          // Load the description
          $('#description').val(packageInfo.notes);
        }
      )
      .getPackageInfoByName(selectedProvider, selectedPackageId);
  }

  /**
   * Load the data set for the selected package
   */
  function onLoadDataSets() {
    const selectedProvider = $('#providers').val();
    const selectedPackageId = $('#packages').val();
    google.script.run.showDataSet(selectedProvider, selectedPackageId);
  }
</script>
